<div class="fb-app">
  <div class="fb-topbar">
    <!-- Primary CTA -->
    <button mat-raised-button color="primary" (click)="openPreview()">
      <mat-icon>visibility</mat-icon>
      Preview
    </button>

    <div class="fb-toolbar-divider"></div>

    <!-- File menu -->
    <button mat-button [matMenuTriggerFor]="fileMenu">
      <mat-icon>folder_open</mat-icon> File <mat-icon>arrow_drop_down</mat-icon>
    </button>
    <mat-menu #fileMenu="matMenu">
      <button mat-menu-item (click)="openExport()"><mat-icon>download</mat-icon> Export Formly JSON</button>
      <button mat-menu-item (click)="openExportBuilder()"><mat-icon>dataset</mat-icon> Export Builder JSON</button>
      <button mat-menu-item (click)="openExportJsonSchema()"><mat-icon>schema</mat-icon> Export JSON Schema</button>
      <mat-divider />
      <button mat-menu-item (click)="openImport()"><mat-icon>upload</mat-icon> Import Builder JSON</button>
      <button mat-menu-item (click)="openImportFormly()"><mat-icon>transform</mat-icon> Import Formly JSON</button>
      <mat-divider />
      <button mat-menu-item class="fb-menu-item-danger" (click)="clear()">
        <mat-icon>delete</mat-icon> Clear canvas
      </button>
    </mat-menu>

    <!-- Templates menu -->
    <button mat-button [matMenuTriggerFor]="templatesMenu">
      <mat-icon>collections_bookmark</mat-icon> Templates <mat-icon>arrow_drop_down</mat-icon>
    </button>
    <mat-menu #templatesMenu="matMenu">
      <button mat-menu-item (click)="saveSelectedAsTemplate()" [disabled]="!canSaveTemplate()">
        <mat-icon>bookmark_add</mat-icon> Save selected as template
      </button>
      <mat-divider />
      <button mat-menu-item (click)="openImportTemplates()"><mat-icon>upload</mat-icon> Import templates</button>
      <button mat-menu-item (click)="openExportTemplates()"><mat-icon>download</mat-icon> Export templates</button>
    </mat-menu>

    <!-- Palette menu -->
    <button mat-button [matMenuTriggerFor]="paletteMenu">
      <mat-icon>palette</mat-icon> Palette <mat-icon>arrow_drop_down</mat-icon>
    </button>
    <mat-menu #paletteMenu="matMenu">
      <button mat-menu-item (click)="openImportPalette()"><mat-icon>upload</mat-icon> Load palette JSON</button>
      <button mat-menu-item (click)="resetPalette()"><mat-icon>restart_alt</mat-icon> Reset palette</button>
    </mat-menu>

    <!-- Layout menu: starter presets + renderer toggle -->
    <button mat-button [matMenuTriggerFor]="layoutMenu">
      <mat-icon>auto_awesome</mat-icon> Layout <mat-icon>arrow_drop_down</mat-icon>
    </button>
    <mat-menu #layoutMenu="matMenu">
      @for (preset of store.presets; track preset.id) {
        <button mat-menu-item (click)="applyPresetById(preset.id)">
          <mat-icon>dashboard_customize</mat-icon> {{ preset.title }}
        </button>
      }
      <mat-divider />
      <button mat-menu-item (click)="store.setRenderer('material')">
        <mat-icon>{{ store.renderer() === 'material' ? 'radio_button_checked' : 'radio_button_unchecked' }}</mat-icon>
        Material UI
      </button>
      <button mat-menu-item (click)="store.setRenderer('bootstrap')">
        <mat-icon>{{ store.renderer() === 'bootstrap' ? 'radio_button_checked' : 'radio_button_unchecked' }}</mat-icon>
        Bootstrap UI
      </button>
    </mat-menu>

    <div class="fb-toolbar-divider"></div>

    <!-- History -->
    <button
      mat-icon-button
      aria-label="Undo"
      matTooltip="Undo (Ctrl+Z)"
      (click)="store.undo()"
      [disabled]="!store.canUndo()"
    >
      <mat-icon>undo</mat-icon>
    </button>
    <button
      mat-icon-button
      aria-label="Redo"
      matTooltip="Redo (Ctrl+Shift+Z)"
      (click)="store.redo()"
      [disabled]="!store.canRedo()"
    >
      <mat-icon>redo</mat-icon>
    </button>
    <button mat-icon-button aria-label="History" matTooltip="History" [matMenuTriggerFor]="historyMenu">
      <mat-icon>history</mat-icon>
    </button>
    <mat-menu #historyMenu="matMenu" class="fb-history-menu">
      <app-builder-history-panel (click)="$event.stopPropagation()" />
    </mat-menu>

    <div class="fb-toolbar-divider"></div>

    <!-- Clipboard (labeled buttons for recognition over recall) -->
    <button
      mat-button
      aria-label="Copy selected"
      matTooltip="Copy (Ctrl+C)"
      (click)="store.copySelected()"
      [disabled]="!canCopyOrDuplicate()"
    >
      <mat-icon>content_copy</mat-icon> Copy
    </button>
    <button
      mat-button
      aria-label="Duplicate selected"
      matTooltip="Duplicate (Ctrl+D)"
      (click)="store.duplicateSelected()"
      [disabled]="!canCopyOrDuplicate()"
    >
      <mat-icon>library_add</mat-icon> Duplicate
    </button>
    <button
      mat-button
      aria-label="Paste"
      matTooltip="Paste (Ctrl+V)"
      (click)="store.pasteFromClipboard()"
      [disabled]="!store.hasClipboard()"
    >
      <mat-icon>content_paste</mat-icon> Paste
    </button>

    <div class="fb-toolbar-divider"></div>

    <!-- Diagnostics indicator -->
    <button
      mat-button
      class="fb-diag-btn"
      [class.fb-diag-error]="store.diagnostics().errorCount > 0"
      [class.fb-diag-warn]="store.diagnostics().errorCount === 0 && store.diagnostics().warningCount > 0"
      (click)="toggleDiagnostics()"
      matTooltip="Toggle diagnostics panel"
    >
      <mat-icon>{{
        store.diagnostics().errorCount > 0 ? 'error' : store.diagnostics().warningCount > 0 ? 'warning' : 'check_circle'
      }}</mat-icon>
      {{ diagnosticsSummary() }}
    </button>
  </div>

  @if (diagnosticsOpen()) {
    <div class="fb-diagnostics">
      <div class="fb-diagnostics-title">Diagnostics</div>
      @if (store.diagnostics().diagnostics.length === 0) {
        <div class="fb-hint">No issues found.</div>
      } @else {
        @for (item of store.diagnostics().diagnostics.slice(0, 12); track $index) {
          <div class="fb-diagnostics-item" [class.fb-diagnostics-item-error]="item.severity === 'error'">
            <strong>{{ item.severity.toUpperCase() }}</strong
            >:
            {{ item.message }}
            @if (item.nodeId) {
              <span class="fb-diagnostics-node">(node {{ item.nodeId }})</span>
            }
          </div>
        }
      }
    </div>
  }

  <div class="fb-workspace">
    <div class="fb-panel">
      <app-builder-palette />
    </div>

    <div class="fb-canvas">
      <app-builder-canvas />
    </div>

    <div class="fb-panel right">
      <app-builder-inspector />
    </div>
  </div>
</div>
