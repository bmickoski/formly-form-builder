<div class="fb-section">
  <div class="fb-inspector-title">Inspector</div>

  @if (!node()) {
    <div class="fb-hint">Select an element on the canvas to edit its settings.</div>
  } @else {
    @let n = node()!;
    @let f = fieldNode();
    @let c = containerNode();

    <div class="fb-hint fb-inspector-editing">
      Editing: <strong>{{ isField() ? 'Field' : 'Layout' }}</strong>
    </div>

    <mat-tab-group [selectedIndex]="selectedTabIndex()" (selectedIndexChange)="onSelectedTabChange($event)">
      <mat-tab label="Basic">
        <div class="fb-tab-content">
          <mat-form-field appearance="outline" class="fb-field">
            <mat-label>Label</mat-label>
            <input matInput [ngModel]="n.props?.label" (ngModelChange)="setProp('label', $event)" />
          </mat-form-field>

          @if (isPanel()) {
            <mat-form-field appearance="outline" class="fb-field">
              <mat-label>Panel title</mat-label>
              <input matInput [ngModel]="c?.props?.title" (ngModelChange)="setProp('title', $event)" />
            </mat-form-field>
          }

          @if (isField()) {
            <mat-form-field appearance="outline" class="fb-field">
              <mat-label>Key</mat-label>
              <input matInput [ngModel]="f?.props?.key" (ngModelChange)="setProp('key', $event)" />
            </mat-form-field>
          }

          <mat-form-field appearance="outline" class="fb-field">
            <mat-label>Placeholder</mat-label>
            <input matInput [ngModel]="n.props?.placeholder" (ngModelChange)="setProp('placeholder', $event)" />
          </mat-form-field>

          <mat-form-field appearance="outline" class="fb-field">
            <mat-label>Description</mat-label>
            <input matInput [ngModel]="n.props?.description" (ngModelChange)="setProp('description', $event)" />
          </mat-form-field>

          <mat-slide-toggle [ngModel]="!!n.props?.hidden" (ngModelChange)="setProp('hidden', $event)"
            >Hidden</mat-slide-toggle
          >
          <mat-slide-toggle [ngModel]="!!n.props?.disabled" (ngModelChange)="setProp('disabled', $event)"
            >Disabled</mat-slide-toggle
          >

          @if (isField()) {
            <mat-divider class="fb-inspector-divider"></mat-divider>
            <div class="fb-section-title">Display rules</div>

            <div
              class="fb-inline-row fb-inline-row-space-between fb-inline-row-align-center fb-inline-row-margin-bottom"
            >
              <div class="fb-subsection-title">Visible when</div>
              @if (!rule('visibleRule')) {
                <button mat-stroked-button type="button" (click)="initRule('visibleRule')">Add rule</button>
              } @else {
                <button mat-button color="warn" type="button" (click)="clearRule('visibleRule')">Clear</button>
              }
            </div>
            @if (rule('visibleRule')) {
              <mat-form-field appearance="outline" class="fb-field">
                <mat-label>Depends on key</mat-label>
                <input
                  matInput
                  [ngModel]="rule('visibleRule')?.dependsOnKey"
                  (ngModelChange)="updateRule('visibleRule', { dependsOnKey: $event })"
                />
              </mat-form-field>
              <mat-form-field appearance="outline" class="fb-field">
                <mat-label>Operator</mat-label>
                <mat-select
                  [ngModel]="rule('visibleRule')?.operator"
                  (ngModelChange)="updateRule('visibleRule', { operator: $event })"
                >
                  @for (op of ruleOperators; track op.value) {
                    <mat-option [value]="op.value">{{ op.label }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
              @if (operatorNeedsValue(rule('visibleRule')?.operator)) {
                <mat-form-field appearance="outline" class="fb-field">
                  <mat-label>Value</mat-label>
                  <input
                    matInput
                    [ngModel]="rule('visibleRule')?.value"
                    (ngModelChange)="updateRule('visibleRule', { value: $event })"
                  />
                </mat-form-field>
              }
            }

            <div class="fb-inline-row fb-inline-row-space-between fb-inline-row-align-center fb-enabled-row">
              <div class="fb-subsection-title">Enabled when</div>
              @if (!rule('enabledRule')) {
                <button mat-stroked-button type="button" (click)="initRule('enabledRule')">Add rule</button>
              } @else {
                <button mat-button color="warn" type="button" (click)="clearRule('enabledRule')">Clear</button>
              }
            </div>
            @if (rule('enabledRule')) {
              <mat-form-field appearance="outline" class="fb-field">
                <mat-label>Depends on key</mat-label>
                <input
                  matInput
                  [ngModel]="rule('enabledRule')?.dependsOnKey"
                  (ngModelChange)="updateRule('enabledRule', { dependsOnKey: $event })"
                />
              </mat-form-field>
              <mat-form-field appearance="outline" class="fb-field">
                <mat-label>Operator</mat-label>
                <mat-select
                  [ngModel]="rule('enabledRule')?.operator"
                  (ngModelChange)="updateRule('enabledRule', { operator: $event })"
                >
                  @for (op of ruleOperators; track op.value) {
                    <mat-option [value]="op.value">{{ op.label }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
              @if (operatorNeedsValue(rule('enabledRule')?.operator)) {
                <mat-form-field appearance="outline" class="fb-field">
                  <mat-label>Value</mat-label>
                  <input
                    matInput
                    [ngModel]="rule('enabledRule')?.value"
                    (ngModelChange)="updateRule('enabledRule', { value: $event })"
                  />
                </mat-form-field>
              }
            }
          }

          @if (isCol()) {
            <mat-divider class="fb-inspector-divider"></mat-divider>
            <div class="fb-section-title">Column</div>
            <mat-form-field appearance="outline" class="fb-field">
              <mat-label>Span (1-12)</mat-label>
              <input
                matInput
                type="number"
                [ngModel]="c?.props?.colSpan"
                (ngModelChange)="setProp('colSpan', +$event)"
              />
            </mat-form-field>

            <div class="fb-inline-row fb-inline-row-gap-sm fb-inline-row-margin-top-sm">
              <button mat-stroked-button type="button" (click)="splitSelectedColumn(2)">Split x2</button>
              <button mat-stroked-button type="button" (click)="splitSelectedColumn(3)">Split x3</button>
            </div>
          }

          @if (isRow()) {
            <mat-divider class="fb-inspector-divider"></mat-divider>
            <div class="fb-section-title">Row</div>
            <div class="fb-inline-row fb-inline-row-gap-sm fb-inline-row-wrap">
              <button mat-stroked-button type="button" (click)="addColumnToSelectedRow()">Add column</button>
              <button mat-stroked-button type="button" (click)="rebalanceSelectedRow()">Rebalance columns</button>
            </div>
          }
        </div>
      </mat-tab>

      <mat-tab label="Validation">
        <div class="fb-tab-content">
          @if (isField()) {
            <mat-slide-toggle [ngModel]="!!f?.validators?.required" (ngModelChange)="setVal('required', $event)"
              >Required</mat-slide-toggle
            >

            <div class="fb-grid-gap fb-grid-gap-margin-top">
              <mat-form-field appearance="outline" class="fb-field">
                <mat-label>Min length</mat-label>
                <input
                  matInput
                  type="number"
                  [ngModel]="f?.validators?.minLength"
                  (ngModelChange)="setVal('minLength', $event === '' ? null : +$event)"
                />
              </mat-form-field>

              <mat-form-field appearance="outline" class="fb-field">
                <mat-label>Max length</mat-label>
                <input
                  matInput
                  type="number"
                  [ngModel]="f?.validators?.maxLength"
                  (ngModelChange)="setVal('maxLength', $event === '' ? null : +$event)"
                />
              </mat-form-field>

              <mat-form-field appearance="outline" class="fb-field">
                <mat-label>Min</mat-label>
                <input
                  matInput
                  type="number"
                  [ngModel]="f?.validators?.min"
                  (ngModelChange)="setVal('min', $event === '' ? null : +$event)"
                />
              </mat-form-field>

              <mat-form-field appearance="outline" class="fb-field">
                <mat-label>Max</mat-label>
                <input
                  matInput
                  type="number"
                  [ngModel]="f?.validators?.max"
                  (ngModelChange)="setVal('max', $event === '' ? null : +$event)"
                />
              </mat-form-field>

              <mat-form-field appearance="outline" class="fb-field">
                <mat-label>Pattern (regex)</mat-label>
                <input matInput [ngModel]="f?.validators?.pattern" (ngModelChange)="setVal('pattern', $event)" />
              </mat-form-field>
            </div>

            <mat-divider class="fb-inspector-divider"></mat-divider>
            <div class="fb-section-title">Async uniqueness</div>
            <mat-slide-toggle [ngModel]="!!asyncUnique()" (ngModelChange)="enableAsyncUnique($event)"
              >Enable unique check</mat-slide-toggle
            >

            @if (asyncUnique()) {
              <mat-form-field appearance="outline" class="fb-field fb-field-margin-top">
                <mat-label>Source</mat-label>
                <mat-select [ngModel]="asyncUnique()?.sourceType" (ngModelChange)="setAsyncUniqueSource($event)">
                  @for (source of asyncUniqueSources; track source.value) {
                    <mat-option [value]="source.value">{{ source.label }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>

              @if (asyncUnique()?.sourceType === 'lookup') {
                <mat-form-field appearance="outline" class="fb-field">
                  <mat-label>Lookup key</mat-label>
                  <input
                    matInput
                    [ngModel]="asyncUnique()?.lookupKey"
                    (ngModelChange)="updateAsyncUnique({ lookupKey: $event })"
                  />
                </mat-form-field>
              }

              @if (asyncUnique()?.sourceType === 'url') {
                <mat-form-field appearance="outline" class="fb-field">
                  <mat-label>URL</mat-label>
                  <input matInput [ngModel]="asyncUnique()?.url" (ngModelChange)="updateAsyncUnique({ url: $event })" />
                </mat-form-field>
                <mat-form-field appearance="outline" class="fb-field">
                  <mat-label>List path (optional)</mat-label>
                  <input
                    matInput
                    [ngModel]="asyncUnique()?.listPath"
                    (ngModelChange)="updateAsyncUnique({ listPath: $event })"
                  />
                </mat-form-field>
                <mat-form-field appearance="outline" class="fb-field">
                  <mat-label>Value key</mat-label>
                  <input
                    matInput
                    [ngModel]="asyncUnique()?.valueKey"
                    (ngModelChange)="updateAsyncUnique({ valueKey: $event })"
                  />
                </mat-form-field>
              }

              <mat-form-field appearance="outline" class="fb-field">
                <mat-label>Error message</mat-label>
                <input
                  matInput
                  [ngModel]="asyncUnique()?.message"
                  (ngModelChange)="updateAsyncUnique({ message: $event })"
                />
              </mat-form-field>
              <mat-slide-toggle
                [ngModel]="!!asyncUnique()?.caseSensitive"
                (ngModelChange)="updateAsyncUnique({ caseSensitive: $event })"
                >Case sensitive compare</mat-slide-toggle
              >

              <div class="fb-inline-row fb-inline-row-gap-sm fb-inline-row-align-center fb-inline-row-margin-top">
                <mat-form-field appearance="outline" class="fb-field fb-field-no-margin">
                  <mat-label>Test value</mat-label>
                  <input
                    matInput
                    [ngModel]="asyncUniqueSampleValue()"
                    (ngModelChange)="setAsyncUniqueSampleValue($event)"
                  />
                </mat-form-field>
                <button mat-stroked-button type="button" (click)="runAsyncUniqueTest()">Test</button>
              </div>
              @if (asyncUniqueTestState() !== 'idle') {
                <div
                  class="fb-hint fb-async-test-status"
                  [class.fb-async-test-success]="asyncUniqueTestState() === 'success'"
                  [class.fb-async-test-loading]="asyncUniqueTestState() === 'loading'"
                  [class.fb-async-test-error]="asyncUniqueTestState() === 'error'"
                >
                  {{ asyncUniqueTestMessage() }}
                </div>
              }
            }
          } @else {
            <div class="fb-hint">Validation settings are available for fields only.</div>
          }
        </div>
      </mat-tab>

      <mat-tab label="Data">
        <div class="fb-tab-content">
          @if (isField()) {
            <div class="fb-section-title">Field extras</div>
            <mat-slide-toggle [ngModel]="!!n.props?.searchable" (ngModelChange)="setProp('searchable', $event)"
              >Searchable (select only)</mat-slide-toggle
            >

            @if (isChoiceField()) {
              <mat-divider class="fb-inspector-divider"></mat-divider>
              <div class="fb-section-title">Options source</div>
              <mat-form-field appearance="outline" class="fb-field">
                <mat-label>Source</mat-label>
                <mat-select [ngModel]="optionsSourceType()" (ngModelChange)="setOptionsSourceType($event)">
                  @for (item of optionsSourceTypes; track item.value) {
                    <mat-option [value]="item.value">{{ item.label }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>

              @if (optionsSourceType() === 'lookup') {
                <mat-form-field appearance="outline" class="fb-field">
                  <mat-label>Lookup key</mat-label>
                  <input
                    matInput
                    [ngModel]="f?.props?.optionsSource?.lookupKey"
                    (ngModelChange)="updateOptionsSource({ lookupKey: $event })"
                  />
                </mat-form-field>
              }

              @if (optionsSourceType() === 'url') {
                <mat-form-field appearance="outline" class="fb-field">
                  <mat-label>URL</mat-label>
                  <input
                    matInput
                    [ngModel]="f?.props?.optionsSource?.url"
                    (ngModelChange)="updateOptionsSource({ url: $event })"
                  />
                </mat-form-field>
                <mat-form-field appearance="outline" class="fb-field">
                  <mat-label>List path (optional)</mat-label>
                  <input
                    matInput
                    [ngModel]="f?.props?.optionsSource?.listPath"
                    (ngModelChange)="updateOptionsSource({ listPath: $event })"
                  />
                </mat-form-field>
                <mat-form-field appearance="outline" class="fb-field">
                  <mat-label>Label key</mat-label>
                  <input
                    matInput
                    [ngModel]="f?.props?.optionsSource?.labelKey"
                    (ngModelChange)="updateOptionsSource({ labelKey: $event })"
                  />
                </mat-form-field>
                <mat-form-field appearance="outline" class="fb-field">
                  <mat-label>Value key</mat-label>
                  <input
                    matInput
                    [ngModel]="f?.props?.optionsSource?.valueKey"
                    (ngModelChange)="updateOptionsSource({ valueKey: $event })"
                  />
                </mat-form-field>
              }

              @if (optionsSourceType() !== 'static') {
                <div class="fb-hint fb-hint-margin-bottom">Static options below are used as fallback.</div>
              }

              <div class="fb-inline-row fb-inline-row-space-between fb-inline-row-align-center fb-options-header">
                <div class="fb-section-title fb-section-title-no-margin">Options</div>
                <button mat-stroked-button type="button" (click)="addOption()">Add option</button>
              </div>

              @for (opt of options(); track $index) {
                <div class="fb-option-card">
                  <mat-form-field appearance="outline" class="fb-field">
                    <mat-label>Label</mat-label>
                    <input matInput [ngModel]="opt.label" (ngModelChange)="updateOption($index, { label: $event })" />
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="fb-field">
                    <mat-label>Value</mat-label>
                    <input matInput [ngModel]="opt.value" (ngModelChange)="updateOption($index, { value: $event })" />
                  </mat-form-field>

                  <div class="fb-inline-row fb-inline-row-gap-sm">
                    <button mat-button type="button" (click)="moveOption($index, -1)">Up</button>
                    <button mat-button type="button" (click)="moveOption($index, 1)">Down</button>
                    <button mat-button color="warn" type="button" (click)="removeOption($index)">Remove</button>
                  </div>
                </div>
              }
            } @else {
              <div class="fb-hint fb-hint-margin-top">Data source settings are available for select/radio fields.</div>
            }
          } @else {
            <div class="fb-hint">Data settings are available for fields only.</div>
          }
        </div>
      </mat-tab>
    </mat-tab-group>

    <mat-divider class="fb-inspector-divider"></mat-divider>
    <button mat-button color="warn" (click)="store.removeSelected()">Delete selected</button>
  }
</div>
